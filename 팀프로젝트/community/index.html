<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>공식홈페이지 – 커뮤니티</title>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <div class="upmenu"></div>
    <section class="hero">
      <div class="container">
        <div class="title">커뮤니티</div>
        <div class="sub">함께 묻고 답하며 성장하는 공간</div>

        <div class="hero-row">
          <div class="chip">🔥 오늘의 인기글</div>
          <div class="chip">✨ 새로 올라온 글</div>
          <div class="chip">📌 공지 확인</div>
        </div>
      </div>
    </section>

    <!-- Community Main -->
    <main class="community">
      <div class="container grid">
        <!-- Sidebar -->
        <aside class="side">
          <h4>카테고리</h4>
          <nav class="catlist" aria-label="커뮤니티 카테고리">
            <a href="#"
              ><span>자유게시판</span><span class="badge">128</span></a
            >
            <a href="#"><span>Q&amp;A</span><span class="badge">64</span></a>
            <a href="#"><span>자료실</span><span class="badge">23</span></a>
            <a href="#"><span>공지사항</span><span class="badge">5</span></a>
            <a href="#"
              ><span>문의 게시판</span><span class="badge">12</span></a
            >
            <a href="#"><span>수강 후기</span><span class="badge">41</span></a>
            <a href="#"><span>강사 후기</span><span class="badge">9</span></a>
            <a href="#"
              ><span>프로그램 다운로드</span><span class="badge">7</span></a
            >
          </nav>

          <div class="tools">
            <div class="search" role="search">
              <input
                type="search"
                placeholder="검색어를 입력하세요"
                aria-label="커뮤니티 검색"
              />
              <button class="btn" type="button">검색</button>
            </div>
            <button class="btn brand" type="button">+ 글 쓰기</button>
          </div>
        </aside>

        <!-- Content Column -->
        <div class="content-col">
          <!-- Notice -->
          <div class="notice" role="note" aria-label="공지">
            <div class="mark">N</div>
            <div>
              <strong>새 학기/모집 일정 안내</strong>
              <div
                class="submeta"
                style="color: var(--muted); font-size: 0.92rem"
              >
                공지사항 · 2025-09-01
              </div>
            </div>
          </div>

          <!-- Tabs -->
          <div class="tabs" role="tablist" aria-label="보기 필터">
            <a class="tab active" role="tab" aria-selected="true" href="#"
              >전체</a
            >
            <a class="tab" role="tab" href="#">공지</a>
            <a class="tab" role="tab" href="#">Q&amp;A</a>
            <a class="tab" role="tab" href="#">자유</a>
            <a class="tab" role="tab" href="#">자료실</a>
          </div>

          <!-- Category Cards -->
          <div class="cards" aria-label="바로가기">
            <article class="card">
              <div class="meta">📌 공지사항</div>
              <div class="title"><a href="#">운영 정책 및 에티켓</a></div>
              <div class="excerpt">
                원활한 커뮤니티 운영을 위한 가이드라인을 확인하세요.
              </div>
            </article>
            <article class="card">
              <div class="meta">❓ Q&amp;A</div>
              <div class="title">
                <a href="#">스프링 의존성 주입이 잘 안돼요</a>
              </div>
              <div class="excerpt">
                @Autowired와 생성자 주입 차이와 설정 팁 정리.
              </div>
            </article>
            <article class="card">
              <div class="meta">💬 자유게시판</div>
              <div class="title"><a href="#">스터디 모집(대전/주말)</a></div>
              <div class="excerpt">
                SQL·자료구조 중심 오프라인 스터디 팀원 구합니다.
              </div>
            </article>
            <article class="card">
              <div class="meta">📚 자료실</div>
              <div class="title"><a href="#">JSP/Servlet 샘플 프로젝트</a></div>
              <div class="excerpt">
                로컬에서 바로 돌릴 수 있는 템플릿과 문서 포함.
              </div>
            </article>
          </div>

          <!-- Feed -->
          <section class="feed" aria-label="최신 글">
            <article class="post">
              <div class="headline">
                <span class="pill">Q&amp;A</span>
                <a class="title" href="#">MySQL 트리거 에러(1442) 해결</a>
              </div>
              <div class="submeta">오늘 · 댓글 5 · 조회 132</div>
            </article>
            <article class="post">
              <div class="headline">
                <span class="pill">자유</span>
                <a class="title" href="#">포트폴리오 메인 색 뭐가 좋을까?</a>
              </div>
              <div class="submeta">어제 · 댓글 12 · 조회 409</div>
            </article>
            <article class="post">
              <div class="headline">
                <span class="pill">자료실</span>
                <a class="title" href="#">HTTP 상태 코드 치트시트 PDF</a>
              </div>
              <div class="submeta">3일 전 · 댓글 2 · 조회 98</div>
            </article>

            <div class="paginate" role="navigation" aria-label="페이지네이션">
              <a class="page" href="#">‹</a>
              <a class="page active" href="#">1</a>
              <a class="page" href="#">2</a>
              <a class="page" href="#">3</a>
              <a class="page" href="#">›</a>
            </div>
          </section>

          <div class="spacer"></div>
        </div>
      </div>
    </main>
  </body>
  <script>
    /* =========================================================
   커뮤니티 프론트엔드: 검색, 필터, 탭, 페이지네이션
   - URL 상태 동기화 (?q=&cat=&tab=&page=)
   - 사이드 카테고리 뱃지 카운트 자동 갱신
   - 반응형/접근성 고려(키보드 포커스 유지)
   ========================================================= */

    document.addEventListener("DOMContentLoaded", () => {
      // ---------- 설정 ----------
      const PAGE_SIZE = 9; // 페이지당 글 수
      const CATEGORIES = [
        "공지사항",
        "Q&A",
        "자유게시판",
        "자료실",
        "문의 게시판",
        "수강 후기",
        "강사 후기",
        "프로그램 다운로드",
      ];
      const TAB_MAP = {
        전체: null,
        공지: "공지사항",
        "Q&A": "Q&A",
        자유: "자유게시판",
        자료실: "자료실",
      };

      // ---------- 요소 참조 ----------
      const $side = document.querySelector(".side");
      const $catLinks = Array.from(document.querySelectorAll(".catlist a"));
      const $searchInput = $side?.querySelector(".search input[type='search']");
      const $searchBtn = $side?.querySelector(".search button");
      const $writeBtn = $side?.querySelector(".btn.brand");
      const $tabs = Array.from(document.querySelectorAll(".tabs .tab"));
      const $feed = document.querySelector(".feed");
      const $paginate = document.querySelector(".paginate");
      const $cardsQuick = Array.from(
        document.querySelectorAll(".cards .card .meta")
      );
      const $notice = document.querySelector(".notice .submeta");

      // ---------- 샘플 데이터 (백엔드 연결 전 데모용) ----------
      // 실제 API 연결 시, fetchPosts()만 교체하면 동일 동작
      const seedRand = (
        (seed) => () =>
          (seed = (seed * 9301 + 49297) % 233280) / 233280
      )(42);
      function randInt(a, b) {
        return Math.floor(seedRand() * (b - a + 1)) + a;
      }
      function daysAgo(n) {
        const d = new Date();
        d.setDate(d.getDate() - n);
        return d;
      }

      const mockPosts = (() => {
        const arr = [];
        const samples = [
          [
            "스프링 의존성 주입이 잘 안돼요",
            "Q&A",
            "@Autowired와 생성자 주입 팁/차이",
          ],
          [
            "MySQL 트리거 에러(1442) 해결",
            "Q&A",
            "동일 테이블 트리거 업데이트 시 해결책",
          ],
          [
            "HTTP 상태 코드 치트시트 PDF",
            "자료실",
            "자주 쓰는 2xx/3xx/4xx/5xx 요약",
          ],
          [
            "스터디 모집(대전/주말)",
            "자유게시판",
            "SQL·자료구조 중심 스터디 팀원 모집",
          ],
          ["운영 정책 및 에티켓", "공지사항", "커뮤니티 이용 가이드라인"],
          [
            "JSP/Servlet 샘플 프로젝트",
            "자료실",
            "로컬에서 바로 실행 가능한 템플릿",
          ],
          [
            "포트폴리오 메인 색 뭐가 좋을까?",
            "자유게시판",
            "브랜딩 컬러 추천 받아요",
          ],
          ["강의 만족도 설문 안내", "공지사항", "학습 개선 설문 참여 안내"],
          [
            "프로그램 다운로드 모음",
            "프로그램 다운로드",
            "개발툴 다운로드 링크 모음",
          ],
          ["강사 후기 – 백엔드 트랙", "강사 후기", "실무 팁이 실렸어요"],
          ["수강 후기 – 취업 성공기", "수강 후기", "프로젝트 경험이 큰 도움"],
          ["파일 업로드가 안돼요", "Q&A", "멀티파트 설정 확인"],
          ["JPA N+1 문제 정리", "자료실", "페치조인, 엔티티그래프로 해결"],
          [
            "오라클 → MySQL 마이그레이션",
            "자료실",
            "스키마/문법 차이 체크리스트",
          ],
          ["회원가입 UX 개선 아이디어", "자유게시판", "폼 단계 줄이기 제안"],
        ];
        for (let i = 0; i < 38; i++) {
          const base = samples[i % samples.length];
          arr.push({
            id: i + 1,
            title: base[0] + (i > 14 ? ` #${i - 14}` : ""),
            category: base[1],
            excerpt: base[2],
            // 최근 글이 위에 오도록 0~35일 섞기
            date: daysAgo(randInt(0, 35)),
            views: randInt(30, 1400),
            comments: randInt(0, 28),
            pinned: base[1] === "공지사항" && randInt(0, 10) > 7,
          });
        }
        // 공지만 몇 개 보장
        arr.push({
          id: 9991,
          title: "새 학기/모집 일정 안내",
          category: "공지사항",
          excerpt: "학사/모집 일정 공지",
          date: daysAgo(3),
          views: 410,
          comments: 2,
          pinned: true,
        });
        arr.push({
          id: 9992,
          title: "커뮤니티 점검 안내",
          category: "공지사항",
          excerpt: "오늘 23:00~23:30",
          date: daysAgo(0),
          views: 200,
          comments: 0,
          pinned: true,
        });
        return arr;
      })();

      // ---------- 상태 ----------
      const state = {
        q: "", // 검색어
        cat: "", // 카테고리(사이드바/카드)
        tab: "전체", // 탭 (전체/공지/Q&A/자유/자료실)
        page: 1, // 페이지
        posts: mockPosts,
      };

      // URL → 상태 복원
      function hydrateFromURL() {
        const p = new URLSearchParams(location.search);
        state.q = (p.get("q") || "").trim();
        state.cat = (p.get("cat") || "").trim();
        state.tab = (p.get("tab") || "전체").trim();
        state.page = Math.max(1, parseInt(p.get("page") || "1", 10) || 1);
        if ($searchInput) $searchInput.value = state.q;
      }

      // 상태 → URL 동기화(페이지 이동/검색 시 주소줄 갱신)
      function syncURL() {
        const p = new URLSearchParams();
        if (state.q) p.set("q", state.q);
        if (state.cat) p.set("cat", state.cat);
        if (state.tab && state.tab !== "전체") p.set("tab", state.tab);
        if (state.page > 1) p.set("page", String(state.page));
        const qs = p.toString();
        history.replaceState(null, "", qs ? `?${qs}` : location.pathname);
      }

      // ---------- 필터/정렬/페이지 ----------
      function normalize(s) {
        return (s || "").toLowerCase();
      }
      function applyFilters() {
        let data = [...state.posts];

        // 탭(공지/Q&A/자유/자료실 → 특정 카테고리와 매핑)
        const tabCat = TAB_MAP[state.tab] || null;
        if (tabCat) data = data.filter((p) => p.category === tabCat);

        // 카테고리(사이드 선택)
        if (state.cat) data = data.filter((p) => p.category === state.cat);

        // 검색(제목/요약)
        if (state.q) {
          const qn = normalize(state.q);
          data = data.filter(
            (p) =>
              normalize(p.title).includes(qn) ||
              normalize(p.excerpt).includes(qn)
          );
        }

        // 정렬: 공지(고정) 먼저, 그 다음 최신순
        data.sort((a, b) => {
          if (a.pinned && !b.pinned) return -1;
          if (!a.pinned && b.pinned) return 1;
          return b.date - a.date;
        });

        return data;
      }

      function paginate(list) {
        const total = list.length;
        const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
        const page = Math.min(state.page, totalPages);
        const start = (page - 1) * PAGE_SIZE;
        const slice = list.slice(start, start + PAGE_SIZE);
        return { slice, total, totalPages, page };
      }

      // ---------- 렌더 ----------
      function fmtDate(d) {
        const y = d.getFullYear(),
          m = String(d.getMonth() + 1).padStart(2, "0"),
          dd = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${dd}`;
      }

      function renderFeed() {
        const list = applyFilters();
        const { slice, total, totalPages, page } = paginate(list);

        // 공지 라벨(상단 notice) 최신 공지 날짜로 갱신
        if ($notice) {
          const latestNotice = state.posts
            .filter((p) => p.category === "공지사항")
            .sort((a, b) => b.date - a.date)[0];
          if (latestNotice) {
            $notice.textContent = `공지사항 · ${fmtDate(latestNotice.date)}`;
          }
        }

        // 피드 본문
        if ($feed) {
          $feed.innerHTML =
            slice
              .map((p) => {
                const pill =
                  p.category === "Q&A"
                    ? "Q&A"
                    : p.category === "자료실"
                    ? "자료실"
                    : p.category === "공지사항"
                    ? "공지"
                    : "자유";
                return `
          <article class="post">
            <div class="headline">
              <span class="pill">${pill}</span>
              <a class="title" href="#">${escapeHtml(p.title)}</a>
              ${
                p.pinned
                  ? `<span class="pill" style="margin-left:8px;background:#fff5d1;border-color:#ffe49e;color:#7a5a00">고정</span>`
                  : ""
              }
            </div>
            <div class="submeta">${fmtDate(p.date)} · 댓글 ${
                  p.comments
                } · 조회 ${p.views}</div>
            <div class="excerpt" style="color:#3b4a50">${escapeHtml(
              p.excerpt
            )}</div>
          </article>
        `;
              })
              .join("") +
            `
        <div class="paginate" role="navigation" aria-label="페이지네이션">
          ${renderPagination(page, totalPages)}
        </div>
      `;
        }

        // 사이드바 카운트 갱신(현재 필터/검색 결과 기준)
        updateCategoryBadges(list);

        // 탭 활성화 표시
        $tabs.forEach((tab) => {
          tab.classList.toggle("active", tab.textContent.trim() === state.tab);
          tab.setAttribute(
            "aria-selected",
            String(tab.classList.contains("active"))
          );
        });

        // 퀵 카드(상단 카테고리 카드)의 메타를 클릭하면 해당 카테고리로 이동
        bindQuickCardClicks();
      }

      function renderPagination(page, totalPages) {
        const prevDisabled =
          page <= 1 ? "aria-disabled='true' tabindex='-1'" : "";
        const nextDisabled =
          page >= totalPages ? "aria-disabled='true' tabindex='-1'" : "";
        const pages = [];
        // 단순 1..N (N이 크면 개선 가능)
        for (let i = 1; i <= totalPages; i++) {
          pages.push(
            `<a class="page ${
              i === page ? "active" : ""
            }" data-page="${i}" href="#">${i}</a>`
          );
        }
        return `
      <a class="page" data-prev href="#" ${prevDisabled}>‹</a>
      ${pages.join("")}
      <a class="page" data-next href="#" ${nextDisabled}>›</a>
    `;
      }

      function updateCategoryBadges(currentList) {
        // 현재 필터/검색을 적용한 "전체 후보"에서 카테고리별 카운트 집계
        const map = new Map(CATEGORIES.map((c) => [c, 0]));
        currentList.forEach((p) =>
          map.set(p.category, (map.get(p.category) || 0) + 1)
        );

        $catLinks.forEach((a) => {
          const name = (a.querySelector("span")?.textContent || "").trim();
          const badge = a.querySelector(".badge");
          if (badge) badge.textContent = map.get(name) ?? 0;
          // 활성 카테고리 표시
          a.classList.toggle("active", state.cat === name);
          a.style.background = a.classList.contains("active") ? "#f6fbf8" : "";
          a.style.fontWeight = a.classList.contains("active") ? "700" : "";
          a.style.border = a.classList.contains("active")
            ? "1px solid #bfead7"
            : "1px solid transparent";
          a.style.transition = "all .15s ease";
          a.style.borderRadius = "12px";
        });
      }

      function bindQuickCardClicks() {
        // .cards의 메타 텍스트(예: "📚 자료실")에서 카테고리 추출
        $cardsQuick.forEach((meta) => {
          const txt = meta.textContent.trim();
          const cat = CATEGORIES.find((c) => txt.includes(c));
          const card = meta.closest(".card");
          if (cat && card && !card.dataset.bound) {
            card.dataset.bound = "1";
            card.style.cursor = "pointer";
            card.addEventListener("click", (e) => {
              e.preventDefault();
              state.cat = cat;
              state.tab = "전체";
              state.page = 1;
              syncURL();
              renderFeed();
              // 포커스 이동(접근성)
              $feed?.scrollIntoView({ behavior: "smooth", block: "start" });
            });
          }
        });
      }

      // ---------- 이벤트 ----------
      // 사이드 카테고리 클릭
      $catLinks.forEach((a) => {
        a.addEventListener("click", (e) => {
          e.preventDefault();
          const name = (a.querySelector("span")?.textContent || "").trim();
          state.cat = state.cat === name ? "" : name; // 토글
          state.tab = "전체";
          state.page = 1;
          syncURL();
          renderFeed();
        });
      });

      // 탭 클릭
      $tabs.forEach((tab) => {
        tab.addEventListener("click", (e) => {
          e.preventDefault();
          const name = tab.textContent.trim();
          state.tab = name;
          // 탭이 특정 카테고리 매핑이면 사이드 카테고리 해제
          if (TAB_MAP[name]) state.cat = "";
          state.page = 1;
          syncURL();
          renderFeed();
        });
      });

      // 검색
      function doSearch() {
        state.q = ($searchInput?.value || "").trim();
        state.page = 1;
        syncURL();
        renderFeed();
      }
      $searchBtn?.addEventListener("click", (e) => {
        e.preventDefault();
        doSearch();
      });
      $searchInput?.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          doSearch();
        }
      });

      // 페이지네이션(이벤트 위임)
      $feed?.addEventListener("click", (e) => {
        const a = e.target.closest("a.page");
        if (!a) return;
        e.preventDefault();
        if (a.hasAttribute("data-prev")) {
          if (state.page > 1) {
            state.page--;
          }
        } else if (a.hasAttribute("data-next")) {
          const list = applyFilters();
          const totalPages = Math.max(1, Math.ceil(list.length / PAGE_SIZE));
          if (state.page < totalPages) {
            state.page++;
          }
        } else {
          const p = parseInt(a.dataset.page || "1", 10) || 1;
          state.page = p;
        }
        syncURL();
        renderFeed();
        // 포커스 유지
        a.blur();
      });

      // 글쓰기(데모용): 간단히 모킹 추가 → 최상단에 반영
      $writeBtn?.addEventListener("click", () => {
        const title = prompt("글 제목을 입력하세요:");
        if (!title) return;
        const category = state.cat || TAB_MAP[state.tab] || "자유게시판";
        state.posts.unshift({
          id: Date.now(),
          title,
          category,
          excerpt: "사용자 작성 글(데모)",
          date: new Date(),
          views: 0,
          comments: 0,
          pinned: false,
        });
        state.page = 1;
        syncURL();
        renderFeed();
      });

      // ---------- 유틸 ----------
      function escapeHtml(s) {
        return String(s).replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[m])
        );
      }

      // ---------- 초기화 ----------
      hydrateFromURL();
      renderFeed();
    });
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("/menu.html")
        .then((res) => res.text())
        .then((html) => {
          document.querySelector(".upmenu").innerHTML = html;
        })
        .catch((err) => console.error("메뉴 로드 실패:", err));
    });
  </script>
</html>
